---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import CTA from "../../components/CTA.astro";
import { getPostBySlug, getPosts } from "../../data/cms";
import { toHTML } from "@portabletext/to-html";

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getPosts();
  return posts
    .filter((post) => post.slug)
    .map((post) => ({ params: { slug: post.slug! } }));
}

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/aktuelles');
}

const post = await getPostBySlug(slug);

if (!post) {
  return Astro.redirect('/aktuelles');
}

const toPlainText = (body: any[] | undefined) => {
  if (!Array.isArray(body)) return '';
  const block = body.find((slice) => slice?._type === 'block' && Array.isArray(slice.children));
  if (!block) return '';
  return block.children.map((child: any) => child?.text ?? '').join(' ');
};

const baseDescription = post.excerpt && post.excerpt.trim().length > 0 ? post.excerpt : toPlainText(post.body);
const metaDescription = baseDescription && baseDescription.length > 0 ? (baseDescription.length > 200 ? `${baseDescription.slice(0, 197)}…` : baseDescription) : '';

const publishedDate = post.publishedAt
  ? new Intl.DateTimeFormat('de-DE', {
      day: '2-digit',
      month: 'long',
      year: 'numeric'
    }).format(new Date(post.publishedAt))
  : null;

const bodyHtml = post.body ? toHTML(post.body) : '';
---

<BaseLayout title={`${post.title} – Repair Café Leonberg`} description={metaDescription ?? ''}>
  <Header />

  <main class="bg-slate-100 py-12 md:py-16">
    <article class="container">
      <div class="mx-auto max-w-3xl">
        <span class="inline-flex items-center gap-2 rounded-full bg-white px-4 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">
          Aktuelles
        </span>
        <h1 class="mt-5 font-display text-4xl font-extrabold text-slate-900 md:text-5xl">{post.title}</h1>
        {publishedDate && (
          <p class="mt-3 text-sm text-slate-500">Veröffentlicht am {publishedDate}</p>
        )}

        {post.coverImage && (
          <figure class="mt-8 overflow-hidden rounded-3xl">
            <img src={post.coverImage} alt={post.title} class="w-full object-cover" loading="lazy" />
          </figure>
        )}

        {metaDescription && (
          <p class="mt-6 text-lg text-slate-700">{metaDescription}</p>
        )}

        <div class="prose prose-slate mt-8 max-w-none" set:html={bodyHtml}></div>
      </div>
    </article>
  </main>

  <CTA />
  <Footer />
</BaseLayout>
