---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import CTA from "../components/CTA.astro";

const pageTitle = 'Kontakt – Repair Café Leonberg';
const pageDescription = 'Kontaktiere das Repair Café Leonberg bei Fragen, Anmerkungen oder für Kooperationen.';
const contactEmail = 'info@repair-leonberg.de';
const contactPhone = '07152 990 4977';
const contactPhoneLink = 'tel:071529904977';
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <Header />

  <main class="bg-slate-100 py-12 md:py-16">
    <section>
      <div class="container">
        <div class="mx-auto max-w-3xl text-center">
          <span class="inline-flex items-center gap-2 rounded-full bg-white px-4 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500 shadow-sm">
            Kontaktformular
          </span>
          <h1 class="mt-5 heading-hero">
            Wir freuen uns auf Ihre Nachricht
          </h1>
          <p class="mt-3 text-base text-slate-600">
            Hier können Sie Anmerkungen hinterlassen, Fragen stellen oder Ihr Engagement anbieten. Wir melden uns so schnell wie möglich zurück.
          </p>
        </div>
      </div>
    </section>

    <section class="mt-12">
      <div class="container">
        <div class="grid gap-8 lg:grid-cols-[1.05fr_0.95fr]">
          <div class="glass rounded-3xl p-8 md:p-10">
            <h2 class="heading-sub">Kontaktformular</h2>
            <p class="mt-3 text-sm text-slate-600">
              Füllen Sie alle Pflichtfelder aus (<span class="text-red-500">*</span>) und wir setzen uns mit Ihnen in Verbindung.
            </p>
            <form
              id="contact-form"
              class="mt-8 space-y-6"
              autocomplete="off"
              data-contact-email={contactEmail}
            >
              <div class="grid gap-6 md:grid-cols-2">
                <div>
                  <label for="contact-name" class="block text-sm font-medium text-slate-700">Name<span class="text-red-500">*</span></label>
                  <input
                    id="contact-name"
                    name="name"
                    type="text"
                    required
                    class="mt-2 w-full rounded-2xl border border-slate-300 bg-white px-4 py-3 text-sm text-slate-900 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500"
                  />
                </div>
                <div>
                  <label for="contact-email" class="block text-sm font-medium text-slate-700">Mail<span class="text-red-500">*</span></label>
                  <input
                    id="contact-email"
                    name="email"
                    type="email"
                    required
                    class="mt-2 w-full rounded-2xl border border-slate-300 bg-white px-4 py-3 text-sm text-slate-900 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500"
                  />
                </div>
              </div>
              <div class="hidden" aria-hidden="true">
                <label for="contact-company">Firma (bitte frei lassen)</label>
                <input id="contact-company" name="company" type="text" tabindex="-1" autocomplete="off" />
              </div>
              <div>
                <label for="contact-message" class="block text-sm font-medium text-slate-700">Nachricht / Anfrage<span class="text-red-500">*</span></label>
                <textarea
                  id="contact-message"
                  name="message"
                  rows={6}
                  required
                  class="mt-2 w-full rounded-2xl border border-slate-300 bg-white px-4 py-3 text-sm text-slate-900 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500"
                ></textarea>
              </div>
              <div class="flex items-center gap-3">
                <input
                  id="contact-copy"
                  name="copy"
                  type="checkbox"
                  class="h-4 w-4 rounded border-slate-300 text-brand-600 focus:ring-brand-500"
                />
                <label for="contact-copy" class="text-sm text-slate-700">Bitte eine Kopie an mich</label>
              </div>
              <div class="flex items-center gap-4">
                <button
                  type="submit"
                  class="inline-flex items-center rounded-full bg-[#DD714D] px-6 py-3 text-sm font-semibold text-white shadow transition hover:-translate-y-0.5 hover:bg-[#c35a39] focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500"
                >
                  Nachricht senden
                </button>
                <p id="contact-status" class="text-sm text-slate-500"></p>
              </div>
            </form>
          </div>

          <div class="space-y-6">
            <div class="rounded-3xl bg-white p-8 shadow-xl shadow-slate-900/5">
              <h3 class="card-title">Direkter Kontakt</h3>
              <p class="mt-3 text-sm text-slate-600">
                Sie erreichen das Orga-Team direkt per Info-Telefon oder E-Mail. Auf Social Media halten wir Sie zudem über Termine auf dem Laufenden.
              </p>
              <div class="mt-6 space-y-3 text-sm">
                <a
                  class="group inline-flex items-baseline text-slate-800 transition hover:text-brand-700 dark:text-slate-100 dark:hover:text-brand-300"
                  href={contactPhoneLink}
                >
                  <span class="font-semibold text-slate-900 dark:text-white">Info-Telefon:</span>
                  <span class="ml-2 text-brand-700 underline-offset-2 group-hover:underline dark:text-brand-300">{contactPhone}</span>
                </a>
                <a
                  class="group inline-flex items-baseline text-slate-800 transition hover:text-brand-700 dark:text-slate-100 dark:hover:text-brand-300"
                  href={`mailto:${contactEmail}`}
                >
                  <span class="font-semibold text-slate-900 dark:text-white">E-Mail:</span>
                  <span class="ml-2 text-brand-700 underline-offset-2 group-hover:underline dark:text-brand-300">{contactEmail}</span>
                </a>
                <div>
                  <span class="font-semibold text-slate-900">Instagram:</span>
                  <a class="ml-2 text-brand-700 hover:underline" href="https://www.instagram.com/repaircafe.leonberg" target="_blank" rel="noopener">@repaircafe.leonberg</a>
                </div>
              </div>
            </div>
            <div class="rounded-3xl bg-white p-8 shadow-xl shadow-slate-900/5">
              <h3 class="card-title">Besuch uns vor Ort</h3>
              <p class="mt-3 text-sm text-slate-600">
                Unsere Veranstaltungen finden verlässlich im Bürgerzentrum Stadtmitte, Neuköllner Straße 5, statt. Alle Termine sehen Sie im Kalender oder auf Nachfrage direkt beim Team.
              </p>
              <a
                class="mt-4 inline-flex items-center gap-2 text-sm font-semibold text-brand-700 hover:underline"
                href="https://www.openstreetmap.org/?mlat=48.7952078&amp;mlon=9.0126756#map=18/48.7952078/9.0126756"
                target="_blank"
                rel="noopener noreferrer"
              >
                Auf Karte ansehen
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <CTA />
  <Footer />

  <script>
    const form = document.getElementById('contact-form');
    const status = document.getElementById('contact-status');
    const submitButton = document.querySelector('#contact-form button[type="submit"]');
    const formLoadedAt = Date.now();

    const setStatus = (message, tone = 'muted') => {
      if (!status) return;
      status.textContent = message;
      const base = 'text-sm';
      const palette =
        tone === 'error'
          ? 'text-red-600'
          : tone === 'success'
            ? 'text-emerald-600'
            : 'text-slate-500';
      status.className = `${base} ${palette}`;
    };

    const setLoading = (loading) => {
      if (!submitButton) return;
      submitButton.disabled = loading;
      submitButton.dataset.loading = loading ? 'true' : 'false';
      submitButton.style.opacity = loading ? '0.7' : '';
    };

    form?.addEventListener('submit', async (event) => {
      event.preventDefault();

      const getTextValue = (id) => {
        const element = document.getElementById(id);
        if (element instanceof HTMLInputElement || element instanceof HTMLTextAreaElement) {
          return element.value.trim();
        }
        return '';
      };

      const getCheckboxValue = (id) => {
        const element = document.getElementById(id);
        return element instanceof HTMLInputElement ? element.checked : false;
      };

      const name = getTextValue('contact-name');
      const email = getTextValue('contact-email');
      const message = getTextValue('contact-message');
      const company = getTextValue('contact-company');
      const copy = getCheckboxValue('contact-copy');

      if (!name || !email || !message) {
        setStatus('Bitte füllen Sie alle Pflichtfelder aus.', 'error');
        return;
      }

      if (company) {
        setStatus(
          'Die Nachricht konnte nicht gesendet werden. Bitte versuchen Sie es erneut oder nutzen Sie alternativ die E-Mail-Adresse.',
          'error'
        );
        return;
      }

      const timeSinceLoad = Date.now() - formLoadedAt;
      if (timeSinceLoad < 2000) {
        setStatus('Bitte senden Sie das Formular noch einmal – ein kurzer Moment verhindert Spam.', 'error');
        return;
      }

      setStatus('Nachricht wird gesendet …', 'muted');
      setLoading(true);

      try {
        const response = await fetch('/api/contact', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, email, message, copy })
        });

        const data = await response.json().catch(() => ({}));

        if (!response.ok) {
          throw new Error(data?.error || 'Die Nachricht konnte nicht gesendet werden.');
        }

        setStatus('Danke! Ihre Nachricht wurde versendet.', 'success');
        form.reset();
      } catch (error) {
        const message =
          error instanceof Error
            ? error.message
            : 'Die Nachricht konnte nicht gesendet werden. Bitte versuchen Sie es später erneut.';
        setStatus(message, 'error');
      } finally {
        setLoading(false);
      }
    });
  </script>
</BaseLayout>
