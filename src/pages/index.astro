---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import NextEventBanner from "../components/NextEventBanner.astro";
import Footer from "../components/Footer.astro";
import Hero from "../components/Hero.astro";
import FAQ from "../components/FAQ.astro";
import CTA from "../components/CTA.astro";
import { getUpcomingEvents, getAllEvents, getPosts, getGalleryImages, getHeroSlides } from "../data/cms";

export const prerender = false;

const [upcomingEvents, allEvents, latestPosts, galleryImages, heroSlides] = await Promise.all([
  getUpcomingEvents(),
  getAllEvents(),
  getPosts(),
  getGalleryImages(),
  getHeroSlides()
]);

const parseEventDate = (eventDate?: string) => {
  if (!eventDate) return null;
  const [year, month, day] = eventDate.split('-').map(Number);
  if (!year || !month || !day) return null;
  return new Date(Date.UTC(year, month - 1, day, 23, 59, 59, 999));
};

const now = new Date();

const ensureUpcomingEvent = (...collections: Array<typeof upcomingEvents>) => {
  for (const events of collections) {
    const match = events.find((event) => {
      const eventDate = parseEventDate(event?.date);
      return eventDate ? eventDate.getTime() >= now.getTime() : false;
    });
    if (match) return match;
  }
  return undefined;
};

const nextEvent = ensureUpcomingEvent(upcomingEvents, allEvents);
const normaliseWhitespace = (value: string) => value.replace(/\s+/g, ' ').trim();

const bodyToPlainText = (body: any[] | undefined) => {
  if (!Array.isArray(body)) return '';
  return body
    .map((slice) => {
      if (slice?._type === 'block' && Array.isArray(slice.children)) {
        return slice.children.map((child: any) => child?.text ?? '').join('');
      }
      if (slice?._type === 'image' && typeof slice?.alt === 'string') {
        return slice.alt;
      }
      return '';
    })
    .join(' ')
    .replace(/\s+/g, ' ')
    .trim();
};

const createPreview = (text: string, limit = 200) => {
  const base = normaliseWhitespace(text);
  if (!base) return '';
  if (base.length <= limit) return base;
  const clipped = base.slice(0, limit);
  const lastSpace = clipped.lastIndexOf(' ');
  const safeClip = lastSpace > 0 ? clipped.slice(0, lastSpace) : clipped;
  return `${safeClip.trim()}…`;
};

const posts = latestPosts.map((post) => {
  const plain = post.bodyPlain && post.bodyPlain.trim().length > 0 ? post.bodyPlain : bodyToPlainText(post.body);
  return { ...post, preview: createPreview(plain ?? '') };
});

const repairCategories = [
  {
    title: 'Elektronik & Kleingeräte',
    desc: 'Toaster, Mixer, Lampen, Kopfhörer, Radios und Kabel – wir finden den Fehler gemeinsam.',
    icon: 'electronics'
  },
  {
    title: 'Textilien',
    desc: 'Nähreparaturen, Knöpfe, Reißverschlüsse und Flicken – damit Lieblingsstücke weiterleben.',
    icon: 'textile'
  },
  {
    title: 'Fahrräder',
    desc: 'Kleinigkeiten wie Bremsen einstellen, Schaltung nachziehen oder Schlauch wechseln.',
    icon: 'bike'
  },
  {
    title: 'Möbel & Holz',
    desc: 'Stühle leimen, Schubladen richten und kleine Holzarbeiten wieder fit machen.',
    icon: 'wood'
  },
  {
    title: 'Spielzeug',
    desc: 'Elektrisches und mechanisches Spielzeug reparieren wir, solange Ersatzteile verfügbar sind.',
    icon: 'toy'
  },
  {
    title: 'Software/Handy',
    desc: 'Einrichtung, Updates, Fehleranalyse und praktische Tipps für digitale Alltagshelfer.',
    icon: 'software'
  }
];

const highlightGallery = galleryImages
  .filter((item) => item.image)
  .filter((item) => item.layout !== 'wide')
  .slice(0, 8);

const testimonials = [
  {
    name: 'Svenja, 34',
    role: 'Leonbergerin seit 10 Jahren',
    quote: 'Ich war total überrascht, wie viel ich selbst reparieren kann – mit Unterstützung und guter Laune macht Technik plötzlich wieder Spaß.'
  },
  {
    name: 'Thomas, 61',
    role: 'Stammgast im Repair Café',
    quote: 'Die Reparatur meines alten Plattenspielers hat geklappt und ich habe noch neue Leute kennengelernt. Das ist echte Nachbarschaftshilfe.'
  },
  {
    name: 'Mira, 22',
    role: 'Studentin & Ehrenamtliche',
    quote: 'Wir lernen voneinander, retten Dinge vor dem Müll und haben dabei noch eine gute Zeit – genau so stelle ich mir Nachhaltigkeit vor.'
  }
];
---

<BaseLayout title="Repair Café Leonberg – Reparieren statt Wegwerfen" description="Reparieren statt Wegwerfen – gemeinsam nachhaltiger in Leonberg. Kostenlos, ehrenamtlich und offen für alle.">
  <Header />
  <NextEventBanner event={nextEvent} ctaHref="/termine" />
  <Hero ctaHref="/termine" heroImages={heroSlides} />

  <section id="angebote" class="mt-16 md:mt-24">
    <div class="container">
      <div class="mx-auto max-w-3xl text-center">
        <h2 class="heading-section">Was wir reparieren</h2>
        <p class="mt-3 text-slate-700 dark:text-slate-300">Wir helfen bei vielen Alltagsgegenständen – je nach Team vor Ort.</p>
      </div>
      <div class="mt-10 grid gap-5 sm:grid-cols-2 lg:grid-cols-3">
        {repairCategories.map((item) => (
          <article class="glass rounded-2xl p-6 transition hover:-translate-y-1 hover:shadow-xl">
            <div class="flex items-start gap-4">
              <span class="flex h-12 w-12 flex-none items-center justify-center rounded-2xl bg-white/80 text-brand-600 shadow-sm shadow-brand-600/20 dark:bg-slate-900/70">
                {item.icon === 'electronics' && (
                  <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                    <rect x="3" y="7" width="18" height="11" rx="2" />
                    <path d="M7 7V5h2v2" />
                    <path d="M15 7V5h2v2" />
                    <path d="M3 14h18" />
                    <path d="M8 18h8" />
                  </svg>
                )}
                {item.icon === 'textile' && (
                  <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                    <circle cx="8" cy="12" r="4" />
                    <circle cx="16" cy="12" r="4" />
                    <path d="M12 5v14" />
                    <path d="M14.5 7.5L21 4" />
                  </svg>
                )}
                {item.icon === 'bike' && (
                  <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                    <circle cx="6" cy="16" r="4" />
                    <circle cx="18" cy="16" r="4" />
                    <path d="M6 16l4-7h4l4 7" />
                    <path d="M10 9l2-3 3 3" />
                  </svg>
                )}
                {item.icon === 'wood' && (
                  <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                    <path d="M4 5h10l2 3h4" />
                    <path d="M4 10h6l2 3h8" />
                    <path d="M4 15h14" />
                    <path d="M4 20h10" />
                  </svg>
                )}
                {item.icon === 'toy' && (
                  <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                    <circle cx="8" cy="8" r="3" />
                    <circle cx="16" cy="8" r="3" />
                    <path d="M5 17h14v3H5z" />
                    <path d="M7 12h10" />
                  </svg>
                )}
                {item.icon === 'software' && (
                  <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                    <rect x="7" y="2" width="10" height="20" rx="2" />
                    <path d="M11 18h2" />
                    <path d="M9 6h6" />
                  </svg>
                )}
              </span>
              <div>
                <h3 class="card-title">{item.title}</h3>
                <p class="mt-2 body-text">{item.desc}</p>
              </div>
            </div>
          </article>
        ))}
      </div>
    </div>
  </section>

  <section id="aktuelles" class="mt-16 md:mt-24">
    <div class="container">
      <div class="mx-auto max-w-3xl text-center">
        <h2 class="heading-section">Aktuelles</h2>
        <p class="mt-3 text-slate-700 dark:text-slate-300">Neuigkeiten, Workshops und Einblicke aus dem Repair Café.</p>
      </div>
      <div class="mt-10 grid gap-8 md:grid-cols-2 xl:grid-cols-3">
        {[...posts].sort((a, b) => (a.date < b.date ? 1 : -1)).slice(0, 3).map((post) => (
          <article class="group flex h-full flex-col overflow-hidden rounded-3xl bg-white shadow-lg shadow-slate-900/5 transition hover:-translate-y-1 hover:shadow-xl">
            {post.coverImage && (
              <div class="relative aspect-[16/10] overflow-hidden bg-slate-200">
                <img src={post.coverImage} alt={post.title} class="h-full w-full object-cover transition duration-500 group-hover:scale-105" loading="lazy" />
              </div>
            )}
            <div class="flex flex-1 flex-col gap-5 px-6 py-6">
              <div class="space-y-2">
                <time datetime={post.publishedAt ?? ''} class="text-xs font-semibold uppercase tracking-[0.2em] text-brand-600">
                  {post.publishedAt
                    ? new Intl.DateTimeFormat('de-DE', {
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric'
                      }).format(new Date(post.publishedAt))
                    : 'Datum folgt'}
                </time>
                <h3 class="card-title">
                  {post.title}
                </h3>
                {post.preview && (
                  <p class="text-sm text-slate-600">{post.preview}</p>
                )}
              </div>
              {post.tags && post.tags.length > 0 && (
                <div class="flex flex-wrap gap-2">
                  {post.tags.map((tag) => (
                    <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">
                      {tag}
                    </span>
                  ))}
                </div>
              )}
              <div class="mt-auto pt-4">
                <a
                  href={post.slug ? `/aktuelles/${post.slug}` : '/aktuelles'}
                  class="inline-flex items-center gap-2 text-sm font-semibold text-brand-600"
                >
                  Mehr erfahren
                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M13 5l7 7-7 7" /></svg>
                </a>
              </div>
            </div>
          </article>
        ))}
      </div>
      <div class="mt-12 text-center">
        <a href="/aktuelles" class="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-5 py-3 text-sm font-semibold text-slate-800 shadow-sm transition hover:-translate-y-0.5 hover:bg-slate-50">
          Alle Beiträge ansehen
        </a>
      </div>
    </div>
  </section>

  <section id="so-gehts" class="mt-16 md:mt-24">
    <div class="container">
      <div class="mx-auto max-w-3xl text-center">
        <h2 class="heading-section">So funktioniert’s</h2>
        <p class="mt-3 text-slate-700 dark:text-slate-300">Wir reparieren gemeinsam – Sie sind Teil der Lösung.</p>
      </div>
      <div class="mt-10 grid gap-5 md:grid-cols-4">
        {[
          { step: '1', title: 'Vorbeikommen', desc: 'Anmeldung ist meist nicht nötig. Bringen Sie Ihr Gerät und ggf. Zubehör mit.' },
          { step: '2', title: 'Check-in', desc: 'Kurz beschreiben, was kaputt ist. Wir finden passende Helfer:innen.' },
          { step: '3', title: 'Gemeinsam reparieren', desc: 'Wir zeigen Ihnen Tricks und gehen Schritt für Schritt vor.' },
          { step: '4', title: 'Teilen & Kaffee', desc: 'Erfolg feiern, Erfahrungen teilen – gerne auch bei Kuchen.' },
        ].map((s) => (
          <div class="glass rounded-2xl p-6">
            <div class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-brand-600/10 font-semibold text-brand-700 dark:text-brand-300">{s.step}</div>
            <h3 class="mt-3 font-semibold text-slate-900 dark:text-white">{s.title}</h3>
            <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">{s.desc}</p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <section id="stimmen" class="mt-16 md:mt-24">
    <div class="container">
      <div class="mx-auto max-w-3xl text-center">
        <h2 class="heading-section">Das sagen Besucher:innen</h2>
        <p class="mt-3 text-slate-700 dark:text-slate-300">Feedback aus dem Repair Café – echte Stimmen, die Mut machen.</p>
      </div>
      <div class="mt-10 grid gap-6 md:grid-cols-2 xl:grid-cols-3">
        {testimonials.map((testimonial) => (
          <figure class="glass flex h-full flex-col rounded-2xl p-6 text-left">
            <blockquote class="text-slate-700 dark:text-slate-300">
              <svg class="mb-3 h-8 w-8 text-brand-600" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M7.17 6A5 5 0 0 0 2 11v7a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-7a1 1 0 0 0-1-1H6.74a3.17 3.17 0 0 1 3-3.57 1 1 0 0 0 1-1V4.72a1 1 0 0 0-1.08-1.01A5 5 0 0 0 7.17 6Zm12 0a5 5 0 0 0-5.17 5v7a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-7a1 1 0 0 0-1-1h-2.26a3.17 3.17 0 0 1 3-3.57 1 1 0 0 0 1-1V4.72a1 1 0 0 0-1.07-1.01A5 5 0 0 0 19.17 6Z" />
              </svg>
              <p class="text-base leading-relaxed">{testimonial.quote}</p>
            </blockquote>
            <figcaption class="mt-6 border-t border-white/40 pt-4 text-sm text-slate-600 dark:text-slate-400">
              <div class="font-semibold text-slate-900 dark:text-white">{testimonial.name}</div>
              <div>{testimonial.role}</div>
            </figcaption>
          </figure>
        ))}
      </div>
    </div>
  </section>

  <section id="faq" class="mt-16 md:mt-24">
    <div class="container">
      <div class="mx-auto max-w-3xl text-center">
        <h2 class="heading-section">Häufige Fragen</h2>
        <p class="mt-3 text-slate-700 dark:text-slate-300">Kurz & knapp beantwortet.</p>
      </div>
      <div class="mt-10">
        <FAQ />
      </div>
    </div>
  </section>

  <section class="mt-16 md:mt-24">
    <div class="container">
      <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
        <div class="max-w-2xl">
          <h2 class="heading-section">
            Eindrücke aus dem Repair Café
          </h2>
          <p class="mt-2 text-slate-700 dark:text-slate-300">
            Wischen Sie durch Momente vom letzten Repair Café – Werkbänke, Workshops und Community in Aktion.
          </p>
        </div>
        <a href="/galerie" class="inline-flex items-center gap-2 self-start rounded-full border border-slate-300 bg-white px-5 py-3 text-sm font-semibold text-slate-800 shadow-sm transition hover:-translate-y-0.5 hover:bg-slate-50">
          Mehr Impressionen ansehen
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M13 5l7 7-7 7" /></svg>
        </a>
      </div>

      <div class="relative mt-8">
        <div class="no-scrollbar flex snap-x snap-mandatory gap-6 overflow-x-auto pb-4 scroll-px-4 md:scroll-px-6">
          {highlightGallery.map((item) => (
            <figure
              class="front-gallery-item snap-center shrink-0 grow-0 basis-3/4 cursor-pointer outline-none transition focus:-translate-y-1 focus:shadow-lg sm:basis-1/2 lg:basis-1/4"
              data-image={item.image}
              data-title={item.title ?? ''}
              data-description={item.description ?? ''}
              data-alt={item.alt ?? item.title ?? ''}
              tabindex="0"
              role="button"
              aria-label={`Bild vergrößern: ${item.title ?? 'Impression'}`}
            >
              <div class="group relative aspect-[3/4] overflow-hidden rounded-[2.25rem] bg-slate-200 shadow-lg shadow-slate-900/10 transition duration-500">
                <img
                  src={item.image}
                  alt={item.alt}
                  loading="lazy"
                  class="h-full w-full scale-105 object-cover transition duration-500 group-hover:scale-110"
                />
                <div class="pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent via-black/10 to-black/60 opacity-0 transition duration-300 group-hover:opacity-100"></div>
                <figcaption class="pointer-events-none absolute inset-x-0 bottom-0 flex flex-col gap-1 px-5 pb-5 text-white opacity-100 transition duration-300 group-hover:opacity-100 md:opacity-0">
                  {item.title && <span class="card-title-sm">{item.title}</span>}
                  {item.description && (
                    <span class="text-xs uppercase tracking-[0.25em] text-white/70">{item.description}</span>
                  )}
                </figcaption>
              </div>
            </figure>
          ))}
        </div>
      </div>
    </div>
  </section>

  <CTA />

  <section class="mt-24">
    <div class="container">
      <div class="grid gap-6 md:grid-cols-2">
        <div class="rounded-3xl bg-white p-8 shadow-lg shadow-slate-900/5 dark:bg-slate-900/60">
          <h2 class="heading-sub">Mitmachen</h2>
          <p class="mt-3 text-sm text-slate-600 dark:text-slate-300">
            Sie möchten selbst reparieren, Gäste empfangen oder im Hintergrund unterstützen? Auf unserer Mitmachen-Seite finden Sie alle Infos zum Einstieg ins Team.
          </p>
          <a
            href="/mitmachen"
            class="mt-5 inline-flex items-center gap-2 rounded-full bg-brand-600 px-5 py-3 text-sm font-semibold text-white shadow transition hover:-translate-y-0.5 hover:bg-brand-700"
          >
            Engagement entdecken
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M13 5l7 7-7 7" /></svg>
          </a>
        </div>
        <div class="rounded-3xl bg-white p-8 shadow-lg shadow-slate-900/5 dark:bg-slate-900/60">
          <h2 class="heading-sub">Partner-Netzwerk</h2>
          <p class="mt-3 text-sm text-slate-600 dark:text-slate-300">
            Reparieren funktioniert am besten gemeinsam. In unserer Übersicht finden Sie Repair Cafés der Umgebung – ideal für Austausch, Termine in Nachbarorten oder gemeinsame Aktionen.
          </p>
          <a
            href="/umgebung"
            class="mt-5 inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-5 py-3 text-sm font-semibold text-slate-800 shadow-sm transition hover:-translate-y-0.5 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
          >
            Netzwerk ansehen
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M13 5l7 7-7 7" /></svg>
          </a>
        </div>
      </div>
    </div>
  </section>

  <section id="kontakt" class="mt-24">
    <div class="container">
      <div class="glass rounded-3xl p-8 md:p-12">
        <div class="grid gap-6 md:grid-cols-2">
          <div>
            <h2 class="heading-sub">Kontakt</h2>
            <p class="mt-3 text-slate-700 dark:text-slate-300">Fragen, Ideen oder Kooperationswunsch? Schreiben Sie uns gern.</p>
            <div class="mt-6 space-y-2 text-sm">
              <div>E-Mail: <a class="text-brand-700 hover:underline dark:text-brand-300" href="mailto:info@repair-leonberg.de">info@repair-leonberg.de</a></div>
              <div>Instagram: <a class="text-brand-700 hover:underline dark:text-brand-300" href="#">@repaircafe.leonberg</a> (optional)</div>
            </div>
          </div>
          <div>
            <div class="rounded-xl bg-slate-100 p-4 text-sm dark:bg-slate-800">
              <p class="font-semibold">Unsere Orte in Leonberg</p>
              <p class="mt-2 text-slate-600 dark:text-slate-300">Die genauen Orte der nächsten Termine geben wir hier und auf Social Media bekannt.</p>
              <a class="mt-3 inline-flex items-center gap-2 text-brand-700 hover:underline dark:text-brand-300" href="https://maps.google.com" target="_blank" rel="noopener">Auf Karte ansehen →</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <Footer />

  <div
    id="front-gallery-lightbox"
    class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-950/80 p-6 backdrop-blur transition duration-300 opacity-0 pointer-events-none"
    role="dialog"
    aria-modal="true"
    aria-labelledby="front-lightbox-title"
  >
    <button
      id="front-gallery-lightbox-close"
      type="button"
      class="absolute right-6 top-6 inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/85 text-slate-800 shadow-lg shadow-slate-900/30 backdrop-blur-sm transition hover:-translate-y-0.5 hover:bg-white"
      aria-label="Galerie schließen"
    >
      <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 6l12 12M6 18L18 6" /></svg>
    </button>
    <div class="max-h-[90vh] w-full max-w-4xl overflow-hidden rounded-[2.25rem] border border-white/10 bg-gradient-to-b from-slate-900/90 via-slate-900/80 to-slate-950/95 shadow-2xl shadow-slate-950/60">
      <div class="relative">
        <div class="flex items-center justify-center bg-slate-900">
          <img id="front-lightbox-image" src="" alt="" class="max-h-[70vh] w-full scale-95 object-contain opacity-0 transition duration-500 ease-out" />
        </div>
        <button
          id="front-gallery-lightbox-prev"
          type="button"
          class="absolute left-4 top-1/2 inline-flex h-12 w-12 -translate-y-1/2 items-center justify-center rounded-full bg-white/80 text-slate-800 shadow-lg shadow-slate-900/30 backdrop-blur-sm transition hover:-translate-y-[calc(50%+4px)] hover:bg-white"
          aria-label="Vorheriges Bild"
        >
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 6l-6 6 6 6" /></svg>
        </button>
        <button
          id="front-gallery-lightbox-next"
          type="button"
          class="absolute right-4 top-1/2 inline-flex h-12 w-12 -translate-y-1/2 items-center justify-center rounded-full bg-white/80 text-slate-800 shadow-lg shadow-slate-900/30 backdrop-blur-sm transition hover:-translate-y-[calc(50%+4px)] hover:bg-white"
          aria-label="Nächstes Bild"
        >
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 6l6 6-6 6" /></svg>
        </button>
        <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-slate-950/95 to-slate-900/10 px-6 py-6 text-center text-white backdrop-blur">
          <h3 id="front-lightbox-title" class="font-display text-lg font-semibold tracking-tight">&nbsp;</h3>
          <p id="front-lightbox-description" class="mt-2 text-sm text-slate-200/80">&nbsp;</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const frontItems = Array.from(document.querySelectorAll<HTMLElement>('.front-gallery-item'));
      const lightbox = document.getElementById('front-gallery-lightbox');
      const lightboxImage = document.getElementById('front-lightbox-image') as HTMLImageElement | null;
      const lightboxTitle = document.getElementById('front-lightbox-title');
      const lightboxDescription = document.getElementById('front-lightbox-description');
      const lightboxClose = document.getElementById('front-gallery-lightbox-close');
      const lightboxPrev = document.getElementById('front-gallery-lightbox-prev');
      const lightboxNext = document.getElementById('front-gallery-lightbox-next');
      let currentIndex = -1;

      function showItem(index) {
        if (!lightboxImage || !lightboxTitle || !lightboxDescription) return;
        const item = frontItems[index];
        if (!item) return;
        const imageSrc = item.dataset.image ?? '';
        if (!imageSrc) return;
        lightboxImage.src = imageSrc;
        lightboxImage.alt = item.dataset.alt ?? '';
        const title = item.dataset.title?.trim();
        const description = item.dataset.description?.trim();
        lightboxTitle.textContent = title && title.length ? title : 'Impression aus dem Repair Café';
        lightboxDescription.textContent = description && description.length ? description : 'Gemeinsam reparieren macht den Unterschied.';
        requestAnimationFrame(() => {
          lightboxImage.classList.remove('scale-95', 'opacity-0');
          lightboxImage.classList.add('scale-100', 'opacity-100');
        });
      }

      function openLightbox(index) {
        if (!lightbox || !lightboxImage) return;
        if (!frontItems.length) return;
        currentIndex = index;
        lightboxImage.classList.remove('scale-100', 'opacity-100');
        lightboxImage.classList.add('scale-95', 'opacity-0');
        lightbox.classList.remove('pointer-events-none', 'opacity-0');
        lightbox.classList.add('opacity-100');
        showItem(currentIndex);
        document.body.classList.add('overflow-hidden');
      }

      function closeLightbox() {
        if (!lightbox || !lightboxImage) return;
        lightbox.classList.add('pointer-events-none');
        lightbox.classList.remove('opacity-100');
        lightbox.classList.add('opacity-0');
        lightboxImage.classList.remove('scale-100', 'opacity-100');
        lightboxImage.classList.add('scale-95', 'opacity-0');
        lightboxImage.src = '';
        document.body.classList.remove('overflow-hidden');
        currentIndex = -1;
      }

      function goTo(step) {
        if (!frontItems.length) return;
        if (currentIndex === -1) return;
        if (!lightboxImage) return;
        const total = frontItems.length;
        currentIndex = (currentIndex + step + total) % total;
        lightboxImage.classList.remove('scale-100', 'opacity-100');
        lightboxImage.classList.add('scale-95', 'opacity-0');
        showItem(currentIndex);
      }

      frontItems.forEach((item, index) => {
        item.addEventListener('click', () => openLightbox(index));
        item.addEventListener('keypress', (event) => {
          if (event.key === 'Enter') {
            openLightbox(index);
          }
        });
      });

      lightboxClose?.addEventListener('click', closeLightbox);
      lightbox?.addEventListener('click', (event) => {
        if (event.target === lightbox) {
          closeLightbox();
        }
      });
      window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeLightbox();
        }
        if (event.key === 'ArrowLeft' && currentIndex !== -1) {
          event.preventDefault();
          goTo(-1);
        }
        if (event.key === 'ArrowRight' && currentIndex !== -1) {
          event.preventDefault();
          goTo(1);
        }
      });
      lightboxPrev?.addEventListener('click', () => goTo(-1));
      lightboxNext?.addEventListener('click', () => goTo(1));
    });
  </script>
</BaseLayout>
